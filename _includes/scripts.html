<script>
    // Theme toggle functionality
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;
    
    // Check for saved theme preference or default to 'light'
    const currentTheme = localStorage.getItem('theme') || 
                       (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    
    if (currentTheme === 'dark') {
        html.classList.add('dark');
    }

    if (themeToggle) {
        themeToggle.addEventListener('click', function() {
            html.classList.toggle('dark');
            
            const theme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
        });
    }

    // Tab functionality
    function showTab(tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.classList.add('hidden');
            content.classList.remove('opacity-0', 'transform');
        });
        
        // Remove active class from all buttons
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
            button.classList.remove('!font-bold', '!text-neutral-800', 'dark:!text-neutral-100');
            button.classList.add('!font-light', '!text-neutral-400', 'dark:!text-neutral-400');
        });
        
        // Show selected tab content
        const selectedContent = document.getElementById(`content-${tabName}`);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
            
            // Add active class to selected button
            const selectedButton = document.getElementById(`tab-${tabName}`);
            if (selectedButton) {
                selectedButton.classList.add('active');
                selectedButton.classList.remove('!font-light', '!text-neutral-400', 'dark:!text-neutral-400');
                selectedButton.classList.add('!font-bold', '!text-neutral-800', 'dark:!text-neutral-100');
            }
            
            // Trigger animations for the new content
            setTimeout(() => {
                selectedContent.classList.add('opacity-0', 'transform');
                selectedContent.classList.add('animate-fade-in');
                
                // Animate list items if they exist
                const listItems = selectedContent.querySelectorAll('li, .space-y-6 > div');
                listItems.forEach((item, index) => {
                    item.classList.add('opacity-0', 'transform-x');
                    item.classList.add('animate-slide-left');
                    item.style.animationDelay = `${(index + 1) * 0.1}s`;
                });
            }, 10);
        }
    }

    // User System Detection
    function detectUserSystem() {
        const userAgent = navigator.userAgent;
        let os = 'Unknown OS';
        let browser = 'Unknown Browser';
        
        // Detect OS
        if (userAgent.indexOf('Win') !== -1) os = 'Windows';
        else if (userAgent.indexOf('Mac') !== -1) os = 'macOS';
        else if (userAgent.indexOf('Linux') !== -1) os = 'Linux';
        else if (userAgent.indexOf('Android') !== -1) os = 'Android';
        else if (userAgent.indexOf('iPhone') !== -1 || userAgent.indexOf('iPad') !== -1) os = 'iOS';
        
        // Detect Browser
        if (userAgent.indexOf('Chrome') !== -1 && userAgent.indexOf('Edg') === -1) browser = 'Chrome';
        else if (userAgent.indexOf('Firefox') !== -1) browser = 'Firefox';
        else if (userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1) browser = 'Safari';
        else if (userAgent.indexOf('Edg') !== -1) browser = 'Edge';
        else if (userAgent.indexOf('Opera') !== -1) browser = 'Opera';
        
        // Get screen resolution
        const screenRes = `${screen.width}x${screen.height}`;
        
        // Get timezone
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        return ` ${os} • ${browser} • ${screenRes} • ${timezone}`;
    }

    // User Location Detection (disabled to avoid external request)
    async function detectUserLocation() {
        return '';
    }
    
    // Combined user info function
    async function updateUserInfo() {
        const systemInfo = detectUserSystem();
        const locationInfo = await detectUserLocation();
        const line = locationInfo ? `${systemInfo} • ${locationInfo}` : systemInfo;
        const userInfoElement = document.getElementById('user-info');
        if (userInfoElement) {
            userInfoElement.textContent = line;
        }
    }

    // IST Clock functionality
    function updateISTClock() {
        const now = new Date();
        const istTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
        
        const timeString = istTime.toLocaleTimeString('en-US', {
            hour12: true,
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const dayString = istTime.toLocaleDateString('en-US', {
            weekday: 'short',
            day: 'numeric',
            month: 'short'
        });
        
        const clockElement = document.getElementById('ist-clock');
        if (clockElement) {
            clockElement.textContent = `${dayString}, ${timeString} IST`;
        }
    }

    // Service Worker Registration for caching
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/assets/sw.js')
                .then(registration => {
                    console.log('SW registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
        });
    }

    // Performance monitoring
    if ('performance' in window) {
        window.addEventListener('load', () => {
            setTimeout(() => {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('Page Load Time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
                console.log('DOM Content Loaded:', perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart, 'ms');
            }, 0);
        });
    }

    // Initialize animations when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Use requestIdleCallback for non-critical animations
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                // Trigger all initial animations
                const animatedElements = document.querySelectorAll('.opacity-0');
                animatedElements.forEach(el => {
                    el.classList.remove('opacity-0');
                    if (el.classList.contains('transform')) {
                        el.classList.remove('transform');
                    }
                    if (el.classList.contains('transform-x')) {
                        el.classList.remove('transform-x');
                    }
                });
            });
        } else {
            // Fallback for browsers without requestIdleCallback
            setTimeout(() => {
                const animatedElements = document.querySelectorAll('.opacity-0');
                animatedElements.forEach(el => {
                    el.classList.remove('opacity-0');
                    if (el.classList.contains('transform')) {
                        el.classList.remove('transform');
                    }
                    if (el.classList.contains('transform-x')) {
                        el.classList.remove('transform-x');
                    }
                });
            }, 100);
        }
        
        // Set initial active tab
        showTab('projects');
        
        // Initialize and start the IST clock
        updateISTClock();
        setInterval(updateISTClock, 1000);
        
        // Initialize user system and location detection with delay
        setTimeout(updateUserInfo, 2000);
    });

    // Notes filtering functionality
    function filterNotes(tag) {
        // Update active tag button
        document.querySelectorAll('.note-tag').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-500', 'text-white', 'dark:bg-blue-400', 'dark:text-white');
            btn.classList.add('bg-zinc-200', 'dark:bg-zinc-700', 'text-zinc-700', 'dark:text-zinc-300');
        });
        
        // Highlight active button
        const activeButton = event.target;
        activeButton.classList.remove('bg-zinc-200', 'dark:bg-zinc-700', 'text-zinc-700', 'dark:text-zinc-300');
        activeButton.classList.add('active', 'bg-blue-500', 'text-white', 'dark:bg-blue-400', 'dark:text-white');
        
        // Filter note items
        const noteItems = document.querySelectorAll('.note-item');
        noteItems.forEach(item => {
            const itemTags = item.getAttribute('data-tags').split(',');
            if (tag === 'all' || itemTags.includes(tag)) {
                item.style.display = 'block';
                item.style.opacity = '1';
            } else {
                item.style.display = 'none';
                item.style.opacity = '0';
            }
        });
    }

    // Mobile menu functionality
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const leftSidebar = document.getElementById('left-sidebar');
    const mobileOverlay = document.getElementById('mobile-overlay');
    
    function toggleMobileMenu() {
        if (leftSidebar && mobileOverlay) {
            leftSidebar.classList.toggle('mobile-open');
            mobileOverlay.classList.toggle('active');
            
            // Prevent body scroll when menu is open
            if (leftSidebar.classList.contains('mobile-open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
    }
    
    function closeMobileMenu() {
        if (leftSidebar && mobileOverlay) {
            leftSidebar.classList.remove('mobile-open');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    // Event listeners
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
    }
    
    if (mobileOverlay) {
        mobileOverlay.addEventListener('click', closeMobileMenu);
    }
    
    // Close menu on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && leftSidebar && leftSidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        }
    });
    
    // Close menu on window resize (if switching to desktop)
    window.addEventListener('resize', function() {
        if (window.innerWidth > 1023 && leftSidebar && leftSidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        }
    });
    
    // Touch gesture support for mobile
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    });
    
    document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const swipeDistance = touchEndX - touchStartX;
        
        // Swipe right to open menu
        if (swipeDistance > swipeThreshold && touchStartX < 50) {
            if (leftSidebar && !leftSidebar.classList.contains('mobile-open')) {
                toggleMobileMenu();
            }
        }
        
        // Swipe left to close menu
        if (swipeDistance < -swipeThreshold && leftSidebar && leftSidebar.classList.contains('mobile-open')) {
            closeMobileMenu();
        }
    }

    // Smooth scrolling for any anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
</script>
